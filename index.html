<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgroControl Pro</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2q6kQ1g8Q+fXw6bNwQKZrP3pJp3y5u1w2trY1hU=" crossorigin="" />
</head>
<body>
    <div class="app-container">
        
        <header class="app-top-bar hidden" id="main-header">
            <button class="btn-sandwich" onclick="toggleMenu()">‚ò∞</button>
            <div class="header-title" id="app-title-display">AgroControl</div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <small id="conexion-indicator" style="font-size: 11px; font-weight: bold; padding: 4px 8px; border-radius: 20px; background: #e8f5e9;">üü¢ En l√≠nea</small>
                <button class="btn-back-right" id="btn-volver" onclick="volverAtras()">‚Üê Volver</button>
            </div>
        </header>

        <div id="side-panel" class="side-panel">
            <div class="panel-header">
                <h3>MEN√ö</h3>
                <button onclick="toggleMenu()" class="btn-close-menu">√ó</button>
            </div>
            <nav class="menu-nav" id="menu-options">
                </nav>
        </div>

        <section id="screen-login" class="pantalla">
            <div class="header-main">
                <h1 style="color: #2d4031; text-align: center;">üöú AgroControl</h1>
                <p style="text-align: center; color: #666;">Gesti√≥n de Pulverizaci√≥n</p>
            </div>
            <div class="form" style="margin-top: 30px;">
                <label>Nombre</label>
                <input type="text" id="login-name" placeholder="Nombre Apellido" />
                <small style="color:#666; display:block; margin-bottom:10px;">Si no existe, se crear√° una cuenta con ese nombre.</small>
                <label>Seleccione Perfil</label>
                <select id="login-role">
                    <option value="ingeniero">Ingeniero Agr√≥nomo</option>
                    <option value="operario">Operario / Aplicador</option>
                </select>
                <button class="btn-primary" onclick="login()">INGRESAR AL SISTEMA</button>
            </div>
        </section>

        <section id="screen-main" class="pantalla hidden">
            <h2 class="section-title">Clientes Activos</h2>
            <div id="lista-clientes"></div>
            <button id="btn-add-client" class="btn-secondary hidden" onclick="crearNuevoCliente()" style="margin-top:15px; border:2px dashed #2d4031; width:100%;">+ NUEVO CLIENTE</button>
        </section>

        <section id="screen-profile" class="pantalla hidden">
            <h2>Mi M√°quina</h2>
            <div class="form card">
                <label>Nombre del Operario</label>
                <input type="text" id="prof-nombre" placeholder="Nombre Apellido">
                <label>Marca/Modelo Pulverizadora</label>
                <input type="text" id="prof-maquina" placeholder="Ej: Metalfor 7040">
                <label>Capacidad del Tanque (Litros)</label>
                <input type="number" id="prof-tanque" placeholder="Ej: 3000">
                <button class="btn-primary" onclick="guardarPerfil()">GUARDAR DATOS</button>
            </div>
        </section>

        <section id="screen-tasks" class="pantalla hidden" style="padding: 0;">
            <div style="padding: 20px 20px 10px 20px;">
                <h2 id="cliente-titulo">---</h2>
            </div>
            <div class="tabs-bar">
                <button class="tab-btn active" id="tab-Nueva" onclick="cambiarTab('Nueva')">NUEVAS</button>
                <button class="tab-btn" id="tab-En Proceso" onclick="cambiarTab('En Proceso')">PROCESO</button>
                <button class="tab-btn" id="tab-Hecho" onclick="cambiarTab('Hecho')">HECHAS</button>
            </div>
            <div id="contenedor-tareas-tab" style="padding: 20px; padding-bottom: 120px;"></div>
            
            <div class="fab-container">
                <button class="btn-fab-stock" onclick="irAStock(seleccion.cliente)">üì¶ STOCK</button>
                <button class="btn-fab-new" onclick="abrirNuevaTarea()">+ TAREA</button>
            </div>
        </section>

        <section id="screen-new-task" class="pantalla hidden">
            <h2>Nueva Orden de Trabajo</h2>
            <div class="form">
                <label>Nombre del Lote</label>
                <input type="text" id="new-task-nombre-input" placeholder="Ej: Lote del Molino">
                
                <label>Hect√°reas Totales del Lote</label>
                <input type="number" id="new-task-ha-total" placeholder="Superficie total">

                <div style="display:flex; align-items:center; margin-bottom:15px; gap:10px; background:#f4f4f4; padding:10px; border-radius:8px;">
                    <input type="checkbox" id="check-parcial" onchange="toggleParcial()" style="width:20px; height:20px; margin:0;">
                    <label for="check-parcial" style="margin:0; font-weight:normal; cursor:pointer; font-size:14px;">¬øAplicar solo una parte?</label>
                </div>

                <div id="box-ha-aplicar" class="hidden" style="animation: fadeIn 0.3s;">
                    <label style="color:#2e7d32;">Hect√°reas a Aplicar (Real)</label>
                    <input type="number" id="new-task-ha-aplicar" placeholder="Cantidad a trabajar" style="border: 2px solid #2e7d32;">
                </div>

                <label>Instrucciones T√©cnicas</label>
                <textarea id="new-task-desc-input" placeholder="Observaciones..."></textarea>
                
                <label>üì∑ Fotograf√≠as de Referencia (Opcional)</label>
                <input type="file" id="new-task-fotos" accept="image/*" multiple style="margin-bottom: 0;">
                <small style="color:#666; display:block; margin-top:6px;">Puedes agregar una o m√°s fotos del lote como referencia.</small>
                <div id="preview-fotos-nueva" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px;"></div>
                
                <div class="receta-form-box">
                    <h4>üß™ Receta (Dosis por Ha)</h4>
                    <div id="lista-insumos-nueva"></div>
                    <button class="btn-secondary" onclick="agregarInsumoInput()" style="margin-top:10px;">+ Agregar Insumo</button>
                </div>

                <label>Aplicador</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <select id="new-task-aplicador" style="flex:1;"></select>
                    <button class="btn-secondary" onclick="agregarAplicadorPrompt()" style="width:140px;">+ Agregar aplicador</button>
                </div>

                <label>Ubicaci√≥n del Lote</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button type="button" class="btn-secondary" onclick="abrirSelectorUbicacion()" style="flex:1;">üìç Seleccionar ubicaci√≥n</button>
                    <span id="new-task-ubic-desc" style="color:#666; white-space:nowrap;">(No definida)</span>
                </div>

                <button class="btn-primary" onclick="guardarNuevaTarea()" style="margin-top:20px;">CREAR ORDEN</button>
            </div>
        </section>

        <section id="screen-task-detail" class="pantalla hidden">
            <div class="task-header-row">
                <h2 id="det-tarea-nombre">---</h2>
                <span id="det-tarea-estado-badge" class="badge-status">---</span>
            </div>
            <div id="det-aplicador-box" class="info-box hidden" style="margin-top:12px;">
                <div class="aplicador-name" id="det-aplicador-name">---</div>
                <div class="aplicador-actions">
                    <button type="button" class="btn-secondary" onclick="abrirGestorAplicadores()">Cambiar aplicador</button>
                </div>
            </div>
            <div class="task-detail-card">
                <div class="info-box" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size:12px; color:#666;">A aplicar:</span><br>
                        <b style="font-size:18px;" id="det-ha-aplicar">---</b> Ha
                    </div>
                    <div style="text-align: right;">
                        <span style="font-size:12px; color:#666;">Lote Total:</span><br>
                        <span id="det-ha-total">---</span> Ha
                    </div>
                </div>
                <div class="info-box"><p id="det-tarea-desc" style="font-size:14px;"></p></div>
                <div class="info-box"><h4>üß™ Receta Planificada</h4><ul id="det-receta-lista" class="product-list"></ul></div>
                <div class="info-box" id="det-fotos-box" style="display:none;">
                    <h4>üì∑ Fotograf√≠as de Referencia</h4>
                    <div id="det-fotos-galeria" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px;"></div>
                </div>
                <div class="info-box" id="det-ubicacion-box">
                    <h4>üìç Ubicaci√≥n del Lote</h4>
                    <div id="det-map" style="height:200px; border-radius:8px; overflow:hidden;"></div>
                    <div id="det-weather" style="margin-top:8px; color:#444;"></div>
                </div>
            </div>
            <div class="action-buttons-group">
                <button class="btn-calc-big" onclick="abrirCalculadora()">üßÆ CALCULADORA DE CARGAS</button>
                <button id="btn-accion-tarea" class="btn-start" onclick="cambiarEstado()">COMENZAR TAREA</button>
                <button id="btn-suspender-tarea" class="btn-suspend" onclick="suspenderTarea()">ANULAR TAREA</button>
            </div>
        </section>

        <section id="screen-calc" class="pantalla hidden">
            <h2>Calculadora</h2>
            <div class="info-box">
                <p>Tanque M√°quina: <b id="resumen-tanque"></b> Lts</p>
                <p>Labor a realizar: <b id="resumen-ha-tarea"></b> Ha</p>
            </div>
            <div class="form">
                <label>Caudal a utilizar (L/Ha)</label>
                <input type="number" id="caudal-input" value="80">
                <button class="btn-primary" onclick="calcularMezcla()">CALCULAR</button>
            </div>
            <div id="resultado-calc" class="resultado hidden">
                <div style="background:#e8f5e9; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #2e7d32;">
                    <p>Rendimiento Tanque: <b id="ha-por-tanque"></b> Ha</p>
                    <p style="font-size:18px; color:#2e7d32; margin-top:5px;">üìã CARGAS: <b id="cant-tanques"></b></p>
                </div>
                <h4>Total Insumos Requeridos:</h4>
                <ul id="lista-mezcla" class="product-list"></ul>
                <div id="aviso-stock-insuficiente"></div>
            </div>
        </section>

        <section id="screen-stock" class="pantalla hidden">
            <h2 id="stock-cliente-titulo">Stock</h2>
            <div id="area-carga-ingeniero" class="form card hidden">
                <h4>Cargar Insumos</h4>
                <input type="text" id="stock-nombre" placeholder="Nombre Producto">
                <input type="number" id="stock-cantidad" placeholder="Cantidad (Litros/Kg)">
                <button class="btn-primary" onclick="agregarStock()">GUARDAR EN DEP√ìSITO</button>
            </div>
            <div id="lista-stock" style="margin-top:20px;"></div>
        </section>

        <section id="screen-finish" class="pantalla hidden">
            <h2>Finalizar Trabajo</h2>
            <p style="font-size:13px; color:#666; margin-bottom:15px;">Confirme las hect√°reas realizadas para descontar del stock.</p>
            <div class="form">
                <label>Hect√°reas Realmente Aplicadas</label>
                <input type="number" id="clima-ha-real" placeholder="Confirmar Ha" style="border: 2px solid #2d4031; font-weight: bold;">
                
                <label>Observaciones Finales</label>
                <textarea id="clima-obs" placeholder="Comentarios del aplicador (clima, problemas, etc)..."></textarea>
                
                <label>üì∑ Fotograf√≠as de Cierre (Opcional)</label>
                <input type="file" id="fotos-finalizacion" accept="image/*" multiple style="margin-bottom: 0;">
                <small style="color:#666; display:block; margin-top:6px;">Agrega fotos del trabajo finalizado como comprobante.</small>
                <div id="preview-fotos-finalizacion" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px;"></div>
                
                <button class="btn-primary" onclick="finalizarDefinitivo()" style="margin-top:20px;">CONFIRMAR Y DESCONTAR STOCK</button>
            </div>
        </section>

        <section id="screen-ubicacion-selector" class="pantalla hidden">
            <h2>Seleccionar Ubicaci√≥n del Lote</h2>
            <p style="font-size:13px; color:#666; margin-bottom:12px;">Toque en el mapa para marcar el punto del lote.</p>
            <div id="ubicacion-map" style="height: 400px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 15px;"></div>
            <div class="info-box" style="background:#e8f5e9; border: 1px solid #2e7d32;">
                <p id="ubicacion-coords" style="font-size: 13px; color: #2e7d32;">Coordenadas: <b>(No seleccionadas)</b></p>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button type="button" class="btn-secondary" onclick="volverAtras()" style="flex:1;">Cancelar</button>
                <button type="button" id="btn-confirmar-ubicacion" class="btn-primary" style="flex:1;" onclick="confirmarUbicacion()" disabled>Confirmar</button>
            </div>
        </section>

        <section id="screen-aplicadores-manager" class="pantalla hidden">
            <h2>Gestionar Aplicadores</h2>
            <p style="font-size:13px; color:#666; margin-bottom:15px;">Cliente: <b id="aplicadores-cliente-nombre"></b></p>
            
            <div style="margin-bottom: 15px;">
                <input type="text" id="buscar-aplicador-input" placeholder="Buscar o crear aplicador..." style="margin-bottom: 0;">
                <small style="color:#666; display:block; margin-top:6px;">Escriba el nombre del aplicador. Si existe, se selecciona. Si no, se crea uno nuevo.</small>
            </div>

            <div id="lista-aplicadores-existentes" style="margin-bottom: 20px;">
                <h4 style="color:#666; font-size:13px; margin-bottom:10px;">Aplicadores Actuales</h4>
            </div>

            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn-secondary" onclick="volverAtras()" style="flex:1;">Cancelar</button>
                <button type="button" id="btn-aplicador-confirmar" class="btn-primary" style="flex:1;" onclick="confirmarSeleccionAplicador()" disabled>Confirmar Selecci√≥n</button>
            </div>
        </section>

        <section id="screen-historial" class="pantalla hidden">
            <h2>Historial de Tareas</h2>
            <p style="font-size:13px; color:#666; margin-bottom:15px;">Registro completo de todas las tareas completadas.</p>
            
            <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                <select id="historial-filtro-cliente" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                    <option value="">Todos los clientes</option>
                </select>
                <button type="button" class="btn-secondary" onclick="exportarExcel()" style="flex: 0 1 auto; margin-bottom: 0;">üìä Excel</button>
                <button type="button" class="btn-secondary" onclick="exportarPDF()" style="flex: 0 1 auto; margin-bottom: 0;">üìÑ PDF</button>
                <button type="button" class="btn-secondary" onclick="limpiarFiltrosHistorial()" style="flex: 0 1 auto; margin-bottom: 0;">Limpiar</button>
            </div>

            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <input type="date" id="historial-fecha-desde" style="flex: 1; margin-bottom: 0;">
                <input type="date" id="historial-fecha-hasta" style="flex: 1; margin-bottom: 0;">
            </div>

            <div id="contenedor-historial" style="padding-bottom: 80px;"></div>
        </section>

        <section id="screen-dashboard" class="pantalla hidden">
            <h2>üìä Dashboard de Control</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                <div class="kpi-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 18px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <small style="opacity: 0.9;">Tareas Totales</small>
                    <div style="font-size: 28px; font-weight: bold; margin-top: 8px;" id="kpi-tareas-totales">0</div>
                    <small style="opacity: 0.85; margin-top: 6px; display: block;" id="kpi-tareas-desglose"></small>
                </div>
                
                <div class="kpi-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 18px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <small style="opacity: 0.9;">Hect√°reas Aplicadas</small>
                    <div style="font-size: 28px; font-weight: bold; margin-top: 8px;" id="kpi-hectareas-aplicadas">0 Ha</div>
                    <small style="opacity: 0.85; margin-top: 6px; display: block;" id="kpi-hectareas-porcentaje"></small>
                </div>
                
                <div class="kpi-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 18px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <small style="opacity: 0.9;">Stock Total</small>
                    <div style="font-size: 28px; font-weight: bold; margin-top: 8px;" id="kpi-stock-total">0 Lts</div>
                    <small style="opacity: 0.85; margin-top: 6px; display: block;" id="kpi-stock-estado"></small>
                </div>
                
                <div class="kpi-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #333; padding: 18px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <small style="opacity: 0.8;">Aplicadores Activos</small>
                    <div style="font-size: 28px; font-weight: bold; margin-top: 8px;" id="kpi-aplicadores">0</div>
                    <small style="opacity: 0.75; margin-top: 6px; display: block;" id="kpi-aplicadores-promedio"></small>
                </div>
            </div>

            <div class="info-box" style="margin-bottom: 15px;">
                <h4>Resumen por Cliente</h4>
                <div id="resumen-clientes" style="margin-top: 12px;"></div>
            </div>

            <div class="info-box">
                <h4>‚ö†Ô∏è Alertas Cr√≠ticas</h4>
                <div id="alertas-criticas" style="margin-top: 12px;"></div>
            </div>
        </section>

        <section id="screen-aplicadores-stats" class="pantalla hidden">
            <h2>üë• Equipo de Aplicadores</h2>
            <p style="font-size:13px; color:#666; margin-bottom:15px;">Estad√≠sticas y desempe√±o del equipo.</p>
            
            <div id="lista-aplicadores-stats" style="padding-bottom: 80px;"></div>
        </section>

    </div>
    <!-- Modal global -->
    <div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content" role="document">
            <h3 class="modal-title"></h3>
            <div class="modal-body"></div>
            <div class="modal-input" style="margin-top:10px;"></div>
            <div class="modal-buttons" style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn-secondary btn-modal-cancel">Cancelar</button>
                <button class="btn-primary btn-modal-ok">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Modal para im√°genes -->
    <div id="modal-imagen" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal-backdrop" onclick="cerrarImagenGrande()"></div>
        <div style="position: relative; width: 90%; max-width: 500px; margin: auto;">
            <button style="position: absolute; top: -40px; right: 0; background: white; border: none; font-size: 28px; cursor: pointer; color: #333;" onclick="cerrarImagenGrande()">‚úï</button>
            <img id="modal-imagen-src" src="" style="width: 100%; border-radius: 12px; max-height: 80vh; object-fit: contain;">
        </div>
    </div>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j7k8mXk8A3zV0UuT0gQF/9/1Z5m6Y2vZr8+gGJg=" crossorigin=""></script>
    <script src="app.js"></script>
</body>
</html>
